# Lenstra椭圆曲线方法(Elliptic Curve Method(ECM))

## 前置知识

### 射影平面

时间回到古希腊时代，欧几里得在《几何原本》中提出了五条公设：

> 1. 任意两点可确定一条直线。
> 2. 任意一条线段可无限延伸成一条直线。
> 3. 给定任一点，已知半径，可作一个圆。
> 4. 所有直角都相等。
> 5. 两条直线被一条直线所截，若截线一侧的同旁内角之和小于两直角之和，则两条直线在这一侧相交。

在该书中，第五条公设仅在第29个命题的证明中使用到了，学界对此公设的存在意义产生了长达两千多年的争论，最终产生了如下的一些几何分支（这里我们主要说明平行线公设这一点存在的不同，其余不同点从略）：

> 1. 欧式几何：满足以上公设
> 2. 罗氏几何（双曲几何）：过直线外一点至少有两条不同的直线和已知直线平行
> 3. 黎曼几何（椭圆几何）：在同一平面内任何两条直线都有公共点（交点），也就是说没有欧式几何下定义的平行线。

我们定义**无穷远点$\infin$**是所谓的“平行线”的交点，这样一来平面上两两直线都统一由唯一的交点，性质如下：

> 1. 一条直线只有一个无穷远点，一对平行线有公共的无穷远点。
> 2. 任何两条不平行的直线有不同的无穷远点（否则会造成有两个交点）
> 3. 平面上全体无穷远点构成一条无穷远直线

进一步，**射影平面**很自然地有如下描述：

> 平面上全体无穷远点与全体平常点构成射影平面。

**射影平面点**的定义如下：

> 对普通平面上点$(x,y)$，令$x=X/Z,y=Y/Z,Z\ne0$，则投影为射影平面上的点$(X:Y:Z)$。

### 射影平面上的椭圆曲线

在射影平面上定义椭圆曲线如下：

> 一条椭圆曲线是在射影平面上满足Weierstrass方程（如下）所有点的集合。
> $$
> Y^{2} Z+a_{1} X Y Z+a_{3} Y Z^{2}=X^{3}+a_{2} X^{2} Z+a_{4} X Z^{2}+a_{6} Z^{3}
> $$

对上式的三点说明：

1. 椭圆曲线方程是一个齐次方程。
2. 曲线上每一个点都是光滑的（即各分量$X,Y,Z$的偏导数不同时为零）。

### 有限域

这里直接给出有限域$F_p$的定义：

> 1. 有限域$F_p$（$p$为质数）中含有元素：$0,1,2,\ldots,p-1$
>
> 2. 有限域$F_p$的运算定义：
>    $$
>    a+b\equiv c \pmod{p}\\
>    a\cdot b\equiv c\pmod{p}\\
>    a\div b\equiv c\pmod{p}
>    $$
>
> 3. 单位元$1$，零元$0$。
> 4. 以上运算满足交换律，结合律，分配律。

### 有限域上的椭圆曲线

取$Z=1$则对应的椭圆曲线的普通方程（这是我们算法中要使用到的方程）如下：
$$
y^{2}+a_{1} x y+a_{3} y=x^{3}+a_{2} x^{2}+a_{4} x+a_{6}
$$

一方面为了方便我们对曲线方程进行操作，我们可以通过平移等操作将$y,xy,x^2$项消去，另一方面椭圆曲线是连续的，并不适合用于加密，我们必须把椭圆曲线变成离散的点，所以得到如下公理化的**有限域椭圆曲线**定义：

> 设$F $是特征不为$2,3$的域，$x^3+ax+b\in F[x]$无平方因子，$O$表示无穷远点，则
> $$
> E=\{(x,y)\in F^2\mid y^2=x^3+ax+b\}\cup\{O\}
> $$
> 称为$F $上的一条椭圆曲线。
>
> 其中$a,b$为满足以下条件的小于$p$的非负整数
> $$
> 4a^3+27b^2\ne 0\pmod{p}
> $$

需要说明的是，特征不为$2,3$以及无平方因子是由我们选取的$a,b$所满足的上述条件决定的。从图像上看，椭圆曲线没有"尖点"。

椭圆曲线图象示例：

![e1](C:\Users\14395\Desktop\e1.png)

![e2](C:\Users\14395\Desktop\e2.png)

### 阿贝尔群

群是一种代数结构，由一个集合以及一个二元运算所组成。已知集合和运算$(G,*)$如果是群则必须满足如下要求：

> 1. 封闭性：$\forall a,b\in G,a*b\in G$
> 2. 结合性：$\forall a,b,c\in G,(a*b)*c=a*(b*c)$
> 3. 存在单位元：$\exist e\in G,\forall a\in G,e*a=a*e=a$
> 4. 存在逆元：$\forall a\in G,\exist b\in G,ab=ba=e$

阿贝尔群在满足以上四条的同时，额外满足交换率$a*b=b*a$。

### 椭圆曲线上的加法运算

设椭圆曲线$E$，点$P,Q\in E$，经过$P,Q$的直线$l$交$E$于三点$\{P,Q,S\}$，令$-S$为点$S$关于$x$轴的对称点，则我们定义加法如下：
$$
P+Q=-S
$$
针对特殊情况的说明：

1. $P=Q$时，$l$为$P$点处切线。
2. $P=-Q$时，$-S$为无穷远点$\infin $。
3. $Q=\infin$，则$P+\infin=-(-P)=P$。
4. $kP=\overbrace{P+P+\cdots+P}^{\text{k times}}$，其中$k$为整数。

由上述定义我们显然可以证明该运算满足阿贝尔群的性质，这里不再赘述，但需要指出的是，该性质保证了算法中递推计算的合法性。

设$P=(x_1,y_1),Q=(x_2,y_2),-S=(x_3,y_3)$则有：
$$
\begin{cases}
x_3=\lambda^2-x_1-x_2\\
y_3=\lambda(x_1-x_3)-y_1
\end{cases}
\text{where } \lambda=
\begin{cases}
\frac{y_1-y_2}{x_1-x_2}&P\ne Q\\
\frac{3x_1^2+a}{2y_1}&P=Q
\end{cases}
$$

这里我们考虑了域$F_p$上的椭圆曲线，然而对于因子分解的认为来说，我们需要考虑$\Z/N\Z$上的椭圆曲线。这里$x_1-x_2$等运算在$\Z/N\Z$上未必可逆，但无伤大雅，有如下解释消除顾虑：

- 当$x_1-x_2$不可逆时，我们可以通过计算$\gcd(x_1-x_2,N)$来计算$N$的非平凡因子，从而直接完成因子分解。
- 当$x_1-x_2$可逆时，我们可以按照有限域上正常的运算进行算法。

因此我们不用花更多的功夫来定义$\Z/N\Z$上的椭圆曲线，同时我们通过判断是否可逆来确定是否完成分解。需要指出的是，从几何上看，$\lambda$是直线$PQ$的斜率，不可逆时$\lambda=\infin$，也就是说我们需找到了一条竖直的线。

## Lenstra ECM具体流程

设要分解的整数$n$，满足$\gcd(n,6)=1$（保证域的特征不为$2,3 $）。

- 随机选取整数$a，b$满足条件$4a^3+27b^2\ne 0\pmod{p}$，$E$为曲线$y^2=x^3+ax+b$。

- 取点$P=(x_1,x_2)$，以及指数$e_k=\lfloor\ln_{p_k}B\rfloor$，根据
  $$
  \begin{cases}
  x_3=\lambda^2-x_1-x_2\\
  y_3=\lambda(x_1-x_3)-y_1
  \end{cases}
  \text{where } \lambda=
  \begin{cases}
  \frac{y_1-y_2}{x_1-x_2}&P\ne Q\\
  \frac{3x_1^2+a}{2y_1}&P=Q
  \end{cases}
  $$
  递推计算
  $$
  P_i=i!P(2\le i\le n)
  $$
  如果计算中出现上述不可逆的$t=x_1 - x_2$情况，则直接分解，否则返回上一步，重新选取$a$。

- 计算$d=\gcd(t,N)$。如果$d\ne N$，则完成分解，否则返回第一步。

## 时间复杂度

以下论断摘自维基百科。

ECM算法的时间复杂度依赖于我们所分解出的因子中最小的一个$p$，具体表达如下：
$$
e^{(\sqrt{2}+o(1)) \sqrt{\ln p \ln \ln p}}
$$
同时，需要指出的是，该算法中多次用到扩展欧几里得算法（实际上是求模逆），并且是针对不同的椭圆曲线求取出的不可逆点处，如何快速求取模逆是该算法的一大优化要点，具体算法有Montgomery加速算法，它能够同时对多条椭圆曲线进行求模逆运算，具体内容读者可参见^[3]^。

## 参考资料

[1] Lenstra elliptic-curve factorization - Wikipedia, the free encyclopedia[EB/OL]. 2019.https://en.wikipedia.org/wiki/Lenstra_elliptic-curve_factorization

[2] 整数因子分解,$maTH\mu$计算机代数系统[EB/OL].2019.http://mathmu.github.io/MTCAS/doc/IntegerFactorization.html#sec

[3] Montgomery modular multiplication - Wikipedia, the free encyclopedia[EB/OL]. 2019.https://en.wikipedia.org/wiki/Montgomery_reduction