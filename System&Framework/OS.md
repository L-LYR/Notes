[TOC]

# 操作系统笔记（复习）

# Chapter1

## 操作系统的发展

- 存储程序式计算机
  - 基本部件
    - CPU：运算器，控制器，寄存器
    - 存储其：存储程序与数据
    - IO设备：输入数据，输出计算结果
  - 特点
    - 过程性：模拟人工
    - 集中控制：CPU集中管理
    - 顺序性：顺序执行

![](./img/os1.png)

- 手工操作阶段
  - 特点
    - 无软件
    - 人工干预
    - 独占性
    - 串行性
  - 问题
    - CPU速度提高导致人机矛盾
- 联机批处理
  - 特点
    - 监督程序
    - 作业自动过渡
  - 问题
    - 高速CPU与低速IO设备的矛盾
  - 解决办法
    - 使用卫星机负责IO
- 脱机批处理
  - 特点
    - 主机与卫星机并行操作
  - 问题
    - 调度不灵活
    - 保护问题
  - 解决方法
    - 通道技术
    - 中断技术
- 执行系统
  - 定义
    - 借助于通道与中断技术，由主机控制IO工作。原有的监督程序不仅要负责调度作业自动地运行，而且还要提供IO控制功能。它常驻内存，称为执行系统。
  - 特定
    - 主机、外设并行操作
    - 增强了保护能力
  - 基本功能
    - IO控制
    - 调度
  - 问题
    - 主机与外设的并行是有限度的，还依赖于程序运行的特征。
- 多道程序设计技术
  - 定义
    - 在计算机主存中同时存放几道相互独立的程序，在操作系统的控制之下，相互穿插地运行。当某道程序因某种原因不能继续运行时（如等待IO完成），操作系统将另一道程序投入运行。（提高吞吐量和资源利用率）
  - 特征
    - 多道
    - 宏观上并行
    - 微观上串行
  - 图例
    - ![](./img/os2.png) ![](./img/os3.jpg)

- 分时技术
  - 定义
    - 把处理机时间划分成很短的时间片（如几十、几百毫秒）轮流地分配给各个程序使用，如果某个程序在分配的时间片用完之前计算还未完成，则该程序暂停执行，等待下一轮继续计算，此时处理机让给另一程序使用。
  - 分时处理
    - 一台计算机和多个终端设备连接，终端用户以联机方式使用计算机。
  - 实时处理
    - 计算机对外来信息能够在被控对象允许的截止期限内做出反应。（实时性和可预测性）

## 操作系统概述

- 资源共享
  - 多个计算任务对计算机系统资源的共同享用
- 资源竞争
  - 多个计算任务对计算机系统资源的争夺
- 定义
  - 操作系统是一个大型的程序系统，它负责计算机系统软、硬件资源的分配；控制和协调并发活动；提供用户接口，使用户获得良好的工作环境。
- 特征
  - 并发，能处理多个同时性活动的能力。
  - 共享，即资源共享。
  - 不确定性，能处理大量的、随机的事件序列，使各用户的计算任务正确地完成。

- 功能
  - 对系统资源实施管理和调度
  - 控制和协调并发活动
  - 对外提供用户接口
- 资源管理功能
  - 处理机管理
    - 提出进程调度策略
    - 给出进程调度算法
    - 进行处理机的分派
  - 存储器管理
    - 存储分配和存储无关性
    - 存储保护
    - 存储扩充
  - 设备管理
    - 设备无关性
    - 设备分配
    - 设备传输控制
  - 信息管理（文件系统）
    - 信息组织
    - 存取方法
    - 文件共享
    - 文件安全
    - 文件完整性
    - 磁盘空间分配

- 分类
  - 批量操作系统
    - 定义
      - 批量操作系统是操作系统的一种类型。该系统把用户提交的程序组织成作业形式。作业成批送入计算机，然后由作业调度程序自动选择作业，在系统内多道运行。
    - 特点
      - 系统吞吐率高（脱机操作，多道运行）
      - 作业周转时间长
  - 分时操作系统
    - 定义
      - 分时操作系统是操作系统的另一种类型。它一般采用时间片轮转的办法，使一台计算机同时为多个终端用户服务。该系统对每个用户都能保证足够快的响应时间，并提供交互会话功能。
    - 特点
      - 并行
      - 独占
      - 交互
  - 实时操作系统
    - 定义
      - 实时操作系统对外部输入的信息，能够在规定的时间内处理完毕并作出反应。
    - 特点
      - 可靠和安全
      - 及时响应
    - 类型
      - 实时控制
      - 实时信息处理
    - 实时系统
      - 硬实时：系统必须满足应用程序对截止期限的要求，若错过了截止期限，将导致灾难性后果。
      - 软实时：系统中截止期限被错过的情况下，只造成系统性能下降而不会带来严重后果。
  - 个人计算机
  - 分布式系统

# Chapter2

## 操作系统结构类型

- 单体结构![](./img/os4.png)
- 模块化结构![](./img/os5.png)
- 可扩展内核结构![](./img/os6.png)
- 层次结构![](./img/os7.png)

- 1. Monolithic Kernel
     1. Entire operating system is placed in kernel space.
     2. All OS code runs in privileged mode (ring 0 on x86).
     3. Different functions of the OS are divided into subsystems.
     4. Higher performance at the expanse of poorer modularity and separation of components.

  2. Micro-Kernel
     1. Bare minimum of code runs in kernel space.
     2. Basic addressing, IPC, and scheduling.
     3. Under 10,000 LOC as a rule of thumb.
     4. Rest of the OS is divided into a collection of servers running in userspace, generally with lower privileges.
     5. Excellent modularity, but performance suffers.

  3. Hybrid Kernel

- ![](./img/os8.png)

- 层次结构
  - UNIX
    - ![](./img/os9.png)
  - Linux
    - ![](./img/os10.png)
  - Windows
    - ![](./img/os11.png)

## 特权级

- 定义
  - 处理机的态，又称处理机的特权级，是中央处理机的工作状态。当前运行的程序决定处理机的态。
  - 程序的类别
    - 管理程序：管理系统资源；控制程序运行
    - 用户程序：使用资源，提出申请；被控制
- 特权级分类
  - 管态：操作系统的管理程序执行时机器所处的状态。在此状态下处理机可使用全部指令（包括一组特权指令）；使用全部系统资源（包括整个存储区域）。
  - 用户态：用户程序执行时机器所处的状态称为用户态。在此状态下禁止使用特权指令，不能直接取用资源与改变机器状态，并且只允许用户程序访问自己的存储区域。

- 特权级划分的目的
  - 保护操作系统
- 特权指令
  - 涉及外部设备的IO指令
  - 修改特殊寄存器的指令
  - 改变机器状态的指令

## 中断

- i386的异常和中断的定义：
  - Exceptions and interrupts are both "==protected control transfers==", which cause the processor to switch from user to kernel mode (CPL=0) ==without giving the user-mode code any opportunity to interfere with the functioning of the kernel or other environments==. In Intel's terminology, an interrupt is a protected control transfer that is caused by an ==asynchronous== ==event== usually ==external== to the processor, such as notification of external device I/O activity. An exception, in contrast, is a protected control transfer caused ==synchronously== by the ==currently running code==, for example due to a divide by zero or an invalid memory access.
  - 异常（Exception）在i386中与trap是一个意思，但中文翻译的时候往往翻译成异常、陷阱或俘获，其实是一个意思。
  - 异常是由于程序的行为（如除0错、缺页等）导致的同步事件，必须由计算机立刻处理。处理完成后，回到程序发生异常处继续执行。
  - 中断是指某个事件（例如键盘输入、I/O传输结束等）发生时，系统中止现行程序的运行，引出处理事件程序对该事件进行处理，处理完毕后返回现行程序的下一条指令，继续执行。
  - 中断处理的时机在指令的间隙，当前指令执行完毕后会检测是否有中断到达，并由系统决定是否进入中断处理。
- 中断源：引起中断的事件称中断源，如打印完成中断，其中断源是打印机。
- 断点：发生中断时正在运行的程序被暂时停止，程序的暂停点称为断点。例如，某程序正在执行0200地址的指令被中断，那么，0200地址就是断点， 在中断返回时就执行0200的下一条指令。
- 中断响应：处理机发现有中断请求时，暂停现运行程序的执行并自动引出中断处理程序的过程。（实质：交换指令地址及处理机的状态信息）
  - ![](./img/os12.png)
- 现场
  - 中断的那一时刻可能确保程序继续运行的有关信息。
    - 后继指令所在主存的单元号
    - 程序运行所处的状态
    - 指令执行情况
    - 程序执行的中间结果等
  - 保护现场
    - 当中断发生时，必须立即把现场信息保存在主存中。
  - 恢复现场
    - 程序重新运行之前，把保留的该程序现场信息从主存中送至相应的指令计数器、通用寄存器或一些特殊的寄存器中。
- 程序状态字
  - 反应程序执行时机器所处的现行状态的代码。
  - 内容：指令地址，指令执行情况，处理机状态，中断屏蔽字等
- 中断装置：指发现中断，响应中断的硬件。
- 中断处理程序：由软件来完成。
- 中断由软硬件协同处理，中断系统 = 中断装置 + 中断处理程序
- 分类
  - 中断
    - 外部中断（非通道设备，如时钟中断）
    - IO中断（外部设备或通道设备）
  - 异常
    - 机器故障
    - 程序性错误或非法操作（运算溢出及错误、越界、非法操作，用户态使用管态指令）
    - 访管中断（系统功能调用）：操作系统提出某种需求（IO请求，创建进程等）

## 硬件

- 存储器
  - 内存（主存）
    - 处理机能直接访问的存储器称为主存储器，用来存放正在或将要执行的系统和用户程序和数据以及程序执行时要求的临时存储空间。
    - ROM、RAM
  - 外存（辅存）
    - 处理机不能直接访问的存储器，如磁盘、磁带、光盘等，用来存放大量的数据信息。
- DMA
  - ![](./img/os13.jpg)
- 时钟硬件
  - ![](./img/os14.jpg)
  - 实时时钟（Real Time Clock，RTC）
    - 在PC机断电后仍能保存时间
    - 通过主板上的电池供电；通常与CMOS RAM集成到一块芯片上，也称为 CMOS Timer
    - 可在系统初启时读入并转换为相对于某一基准时间的时钟滴答数
    - 操作系统提供实用程序可以设置系统时钟和RTC并在二者之间同步
  - 可编程间隔定时器（Programmable Interval Timer，PIT）
    - 工作模式
      - One-shot mode
      - Square-wave mode
    - 时钟滴答（Clock tick）
    - 周期性地发生时钟中断（可编程设置间隔）
  - 时间戳计数器（Time Stamp Counter，TSC）
    - Pentium之后的CPU中包含的64位的寄存器
    - 在每一个振荡信号到达时，该计数器递增
    - 可为操作系统提供更准确的时间度量

# Chapter3

## 系统引导

- 将操作系统的必要部分装入主存并对系统进行初始化工作，最终使系统处于命令接收状态。
- 方式
  - 现场独立引导：OS核心文件存储在系统本身的存储设备中，由系统自己将OS核心程序读入主存并运行，建立一个操作环境。
    1. 初始引导
       1. 系统加电
       2. 执行初始引导程序，对系统硬件和配置进行自检，保证系统没有硬件错误
       3. 从硬盘中读入操作系统引导程序，并将控制权交给该程序模块
    2. 引导程序执行，将操作系统核心文件读入内存，并将控制交给核心的初始化程序
    3. 核心初始化，初始化系统数据结构和参数
       1. 系统加电建立进程有关的数据结构
       2. 获得自由存储空间的容量，建立存储管理的数据结构
       3. 建立系统设备和文件系统的数据结构
       4. 初始化时钟
    4. 系统初始化
       1. 完善OS的操作环境，装载命令处理程序 (或图形用户界面)，并初始化
       2. 在多用户系统中，为每个终端建立命令解释进程，使系统处于命令接收状态
  - 辅助下装
    - OS主要文件不放在系统本身的存储设备中，在系统启动后执行下装操作，从另外的计算机系统中将操作系统常驻部分传送到该计算机中，使它形成一个操作环境。
- 举例：Linux
  1. 系统加电或复位
     1. 对主存中所有数据清零，进行校验，无错则将程序计数器指向BIOS入口。
  2. BIOS启动
     1. 上电自检
     2. 对硬件设备进行检测和连接，并将测得的数据送入BIOS数据区
     3. 读入Boot Loader引导程序（对MBR启动方式，则是启动零柱面零磁道1扇区的MBR（Master Boot Record），将控制权交给Boot Loader）
  3. 引导程序
     1. 将OS读入内存，并将控制权交给OS初始化程序
  4. 系统核心初始化（Setup.s）
     1. Setup
        1. 检查调入内存中的代码
        2. 获取内存容量信息，设置设备模式
        3. 屏蔽中断，准备进入保护模式
        4. 设置中断描述符表（idt），全局描述符表（gdt）
        5. 控制权交给Heads
     2. Heads
        1. 对中断向量表作准备工作
        2. 检查CPU类型
        3. 调用Setup_paging进行页面初始化
        4. 调用main.c中的`Start_kernel()`。
     3. `Start_kernel()`
        1. 对与CPU、内存等最基本硬件相关部分进行初始化
        2. 对中断向量表进行初始化
        3. 为进程调度程序作准备
        4. 设置基准时钟
        5. 内核的内存分配
        6. 对文件系统进行初始化
        7. 建立init进程
     4. init进程：对每一个联机终端建立“getty”进程，getty在终端上显示“login”，等待用户登录

## 应用程序处理

![](./img/os15.png)

- 链接类型

  - 静态链接

    - 一个源程序经编译后，生成一个可重定位的目标模块，并产生内部符号表和外部符号表，供连接程序（Link）使用。
    - 内部符号表：本模块可以被其他程序调用的入口点。（全局符号表）

    - 外部调用表：本模块要调用的外部的程序模块名。
    - 连接需要做的工作
      1. 将各模块连接成为一个整体
      2. 构造符号表，在其中填写模块的逻辑地址
      3. 查找各程序段的外部调用表，填入对应调用函数的地址
    - 缺点：静态连接将所需的外部函数链接到目标文件中形成为一个可执行文件。若多个应用程序都调用了同一个库中的外部函数，那么，多个应用程序的目标文件中都会包含这个外部函数对应的代码

  - 动态连接

    - 不需要将外部函数链接到目标文件中，而是在应用程序中需要调用外部函数的地方作记录，说明要使用的外部函数名和引用入口。

## 系统功能调用

- 用户界面
  - 命令接口（操作界面）
    - 用户使用操作界面来组织工作流程和控制程序的运行。
      - 作业控制语言
      - 键盘命令
      - 图形化用户界面
  - 程序接口（系统功能服务界面）
    - 用户程序在其运行过程中，使用系统功能调用来请求操作系统的服务。

- 系统功能调用
  - 操作系统提供实现各种功能的例行子程序，其中的每一个功能对应访管指令的一个功能号。调用方法：访管指令+访管中断
  - 系统功能调用是用户在程序一级请求操作系统服务的一种手段，它是带有一定功能号的访管指令。其功能是由操作系统中的程序完成的，即由软件方法实现的。
  - ![](./img/os16.png)

# Chapter4

- 程序的一次执行过程被称为一个计算，它由许多简单操作所组成。
- 顺序程序
  - 一个计算的若干操作必须按照严格的先后次序顺序地执行，这类计算过程就是程序的顺序执行过程。
  - 特点
    - 顺序性：处理机严格按照程序所规定的顺序执行
    - 封闭性：程序开始执行后，结果不受外界因素影响
    - 可再现性：程序执行的结果和它执行的速度无关（与时间无关），只与初始条件有关

- 并发程序
  - 若干个程序段同时在系统中运行，这些程序段的执行在时间上是重叠的，一个程序段的执行尚未结束，另一个程序段的执行已经开始，即使这种重叠是很小的一部分，也称这几个程序段是并发执行的。
  - 特点
    - 失去了程序的封闭性和可再现性：若一程序可以修改另一个程序中的变量（公共变量），则后者的输出可能有赖于各个程序运行的相对速度。
    - 程序与计算不再一一对应：一个程序可能对应多个计算。
    - 程序并发执行的相互制约：资源共享和公共变量。
- 与时间有关的错误
  - 程序并发执行时，若共享了公共变量，其执行结果与各个并发程序之间的相对速度有关，即给定初始条件，若不加控制，也可能得到不同的结果，这就是与时间有关的错误。

## 进程

- 定义
  - 一个程序在给定的活动空间和初始环境下，在一个处理机上的一次执行过程。
- 与程序的区别
  1. 程序是静态概念，进程是动态概念
  2. 进程是一个独立运行的活动单位
  3. 进程是竞争系统资源的基本单位
  4. 一个程序可以对应多个进程，一个进程至少包含一个程序
- 基本状态
  - 运行：进程已经获取运行所必需的资源，正在处理机上执行
  - 等待：进程正在等待某一时间的发生而暂停执行，这时，即使给予其CPU的控制权，它也无法执行。
  - 就绪：进程已经获取除CPU以外的全部必需资源，一旦得到CPU的控制权，它可以立即执行。
  - ![](./img/os17.png)
- 进程控制块（Process Control Block）
  - 描述进程与其他进程、系统资源的关系以及进程在各个不同时期所处的状态的*数据结构*，称为进程控制块。
  - 进程的组成：程序+数据+PCB
  - 主要内容：
    1. 进程标识符（PID）
    2. 进程当前状态（处于等待态，需要说明原因）
    3. 当前队列指针（next，队列中即处于同一状态的下一个PCB的地址）
    4. 进程优先级（由用户预先指定或由OS指定）
    5. CPU现场保护区（上下文，现场保护）
    6. 通信信息
    7. 家族联系（子进程，父进程标识符）
    8. 占有资源清单

## 进程控制

- 控制原语
  - 创建：`create(name, priority)`
    - 创建一个指定标识符的进程，并构建其PCB数据结构。
    - ![](./img/os18.png)
  - 撤销：`kill / exit`
    - 当进程完成任务后希望终止自己时使用进程撤消原语。 
    - 撤消当前运行的进程。将该进程的PCB结构归还到PCB资源池，所占用的资源归还给父进程，从总链队列中摘除它，然后转进程调度程序。
    - ![](./img/os19.png)
  - 等待：`susp(chan)`
    - 当进程需要等待某一事件完成时，它可以调用等待原语挂起自己。
    - 中止调用进程的执行，并加入到等待`chan`的等待队列中，最后使控制权转向进程调度。
    - ![](./img/os20.png)
  - 唤醒：`wakeup(chan)`
    - 当处于等待状态的进程所期待的事件来到时，由发现者进程使用唤醒原语叫唤醒它。
    - ![](./img/os21.png)

## 制约关系

- 临界资源：同一时刻即一次仅允许一个进程占用的资源叫做临界资源
- 临界区：进程中对公共变量（或存储区）进行访问和修改的程序段，称为相对于该公共变量的临界区。进程进入临界区必须互斥。
  - 针对某一临界资源而言
  - 某一临界资源的临界区数等于共享该临界资源的进程数
  - 互斥进入。

- 互斥

  - 在操作系统中，当某一进程正在访问某一存储区域时，不允许其他进程来读出或者修改该存储区的内容，否则就会发生后果无法估计的错误。进程之间的这种相互制约关系被称为互斥。

- 同步

  - 并发进程在一些关键点上需要互相等待和互通消息，这种相互制约的等待和互通信息称为进程同步。

- 同步机构

  - 锁：用锁位表示一个资源（被占用）的状态。

    - ![](./img/os22.png)

    - 上锁原语

      ```c
      test:
      	if (w == 1) goto test;  // 轮询
          else w = 1;				// 上锁
      ```

    - 开锁原语

      ```c
      	w = 0; // 开锁
      ```

  - 信号灯：信号灯是一个确定的二元组`(s, q)`，s是一个具有非负初值的整型变量，q是一个初始状态为空的队列。

    - 注：创建信号灯时，要准确说明其初值（不能为负）和意义。
    - P操作
      - 对信号灯s的 p操作记为 p(s)。p(s)是一个不可分割的原语操作，即取信号灯值减1，若相减结果为负，则调用p(s)的进程被阻，并插入到该信号灯的等待队列中，否则可以继续执行。
      - ![](./img/os23.png)
    - V操作
      - 对信号灯s的 v操作记为 v(s)。v(s)是一个不可分割的原语操作，即取信号灯值加1，若相加结果大于零，进程继续执行，否则，要帮助唤醒在信号灯等待队列上的一个进程。
      - ![](./img/os24.png)

## 通信

- 定义
  - 进程通信是指进程之间直接以较高的效率传递较多数据的信息交互方式。
- 分类
  - 消息缓存通信
    - 发送双方有明确的协议与消息格式。
    - 包括消息缓冲、发送原语和接收原语。
  - 信箱通信
    - 需要定义信箱结构，包括发送模块和接收模块，提供发送原语和接收原语。
    - 可以放在用户空间，作为接收进程地址空间的一部分，也可以放在内核空间。

## 线程

- 定义
  - 线程是比进程更小的活动单位，是进程中的一条执行路径。
  - 可以拥有私用的堆栈和处理机执行环境。
  - 与父进程共享分配给父进程的主存。
  - 单个进程可以创建多个线程。
- ![](./img/os25.png)

# Chapter5

- 资源描述器
  - 描述描述各类资源的最小分配单位的数据结构称为资源描述器rd。
  - ![](./img/os27.png)
  - ![](./img/os28.png)

- 资源分配策略
  - 先请求先服务
    - 每一个新产生的请求均排在队尾；当资源可用时，取队首元素，满足其需求。
    - 排序原则：按请求的先后次序。
  - 优先调度
    - 对每一个进程指定一个优先级；每一个新产生的请求，按其优先级的高低插入到相应的位置；当资源可用时，取队首元素，满足其需求。
    - 排序原则：按优先级的高低排序。
  - 针对设备特性设置调度策略

## 死锁

- 定义
  - 在两个或多个并发进程中，如果每个进程持有某种资源而又都等待着别的进程释放它或它们现在保持着的资源，否则就不能向前推进。此时称这一组进程产生了死锁。
- 原因
  1. 系统资源不足
  2. 进程推进顺序非法
- 必要条件
  - 互斥条件：涉及到的资源是非共享的，即临界资源
  - 不剥夺条件：进程所获得的资源在未使用完毕之前，不能被其他进程强行夺走。
  - 部分分配：进程每次申请它所需要的一部分资源。在等待新资源的同时，进程继续占用已分配得到的资源。
  - 环路条件：存在一种进程的循环链，链中的每一个进程已获得的资源同时被链中下一个进程所请求。
- 安全状态
  - 指至少有一个资源分配序列使得进程不会死锁。

- 解决死锁的策略
  - 静态资源分配
    - 在作业调度时为选中的作业分配它所需要的所有资源，当资源一旦分配给该作业后，在其整个运行期间这些资源为它独占。
  - 有序资源分配法
    - 系统中所有资源都给定一个唯一的编号，所有分配请求必须以上升的次序进行。当遵守上升次序的规则时，若资源可用，则予以分配；否则，请求者等待。
  - 银行家算法
    - 申请者事先说明对各类资源的最大需求量。在进程活动期间动态申请某类资源时，由系统审查现有该类资源的量是否满足，同时分配后是否处于安全状态，如能满足就予以分配，否则拒绝。